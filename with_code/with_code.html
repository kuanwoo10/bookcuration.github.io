<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>터미널 챗</title>
  
  <!-- (선택) 모달 본문에 사용할 나눔고딕 웹폰트 로드 -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap">

  <style>
    :root{
      --bg:#0b1020; --panel:#0f172a; --ink:#e5e7eb; --dim:#94a3b8; --green:#22c55e; --cyan:#06b6d4; --danger:#ef4444; --border:#1f2937;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --space: 12px; --radius: 12px; --tap: 44px;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; margin:0; background:linear-gradient(180deg,#0a0f1e,#0d1530); }
    body{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      color:var(--ink); display:flex; align-items:center; justify-content:center;
      touch-action: manipulation; font-size: clamp(14px, 3.3vw, 16px); line-height: 1.4;
    }
    .app{ position:relative; width:min(920px,100%); height:100lvh; max-height:820px; background:var(--panel);
      border:1px solid var(--border); border-radius:14px; box-shadow:0 18px 40px rgba(0,0,0,.35);
      display:flex; flex-direction:column; overflow:hidden; }
    /* dvh 지원 시 우선 사용 */
    @supports (height: 100dvh){ .app{ height:100dvh; } }
    /* lvh 미지원 브라우저 폴백 */
    @supports not (height: 100lvh){ .app{ height:100vh; } }

    .titlebar{ display:flex; align-items:center; justify-content:space-between; padding:8px 12px;
      border-bottom:1px solid var(--border); background:linear-gradient(180deg,#111827,#0f172a); min-height:var(--tap); }
    .dots{ display:flex; gap:6px } .dot{ width:8px; height:8px; border-radius:50% }
    .dot.red{background:#ef4444}.dot.yellow{background:#f59e0b}.dot.green{background:#22c55e}
    .title{ font-weight:800; letter-spacing:.3px; font-size: clamp(14px, 3.5vw, 16px); }
    .status{ font-size:12px; color:var(--dim) } .status .on{ color:var(--green) }
    @media (max-width:360px){ .status{ display:none } }

    .log{ position:relative; flex:1; overflow-y:auto; padding:12px;
      background:repeating-linear-gradient(0deg,#0f172a,#0f172a 22px,#0e162d 22px,#0e162d 44px);
      scroll-behavior:smooth; overscroll-behavior:contain; padding-bottom:0; word-break:break-word; overflow-wrap:anywhere; }
    .line{ display:flex; gap:8px; margin:6px 0; white-space:pre-wrap; }
    .line.vstack{ flex-direction:column; align-items:flex-start; }
    .line.vstack .prompt{ margin-bottom:2px }
    .line.vstack .out{ width:100% }
    .prompt{ color:var(--green); flex:0 0 auto }
    .user .prompt::after{ content:"$" } .bot .prompt::after{ content:"#" }
    .sys{ justify-content:center; color:var(--dim); font-size:12px }
    .out{ color:var(--ink); flex:1; min-width:0 }
    .dim{ color:var(--dim) } .err{ color:var(--danger) }

    .footer{ position:absolute; left:0; right:0; bottom:0; z-index:10; transition:transform .18s ease;
      padding:var(--space); padding-bottom:calc(var(--space) + var(--safe-bottom));
      background:linear-gradient(180deg, rgba(13,21,48,0), #0f172a 60%); transform:translate3d(0,0,0); will-change:transform; }
    .cats{ display:flex; gap:8px; padding:8px 10px; border:1px solid var(--border); border-radius:12px; margin-bottom:8px;
      background:#0b1224; overflow-x:auto; scrollbar-width:thin; -webkit-overflow-scrolling:touch; }
    .cats.hidden{ display:none !important }
    .cats::-webkit-scrollbar{ height:6px } .cats::-webkit-scrollbar-thumb{ background:#1f2a44; border-radius:999px }
    .cat-chip{ flex:0 0 auto; padding:8px 12px; border:1px solid var(--border); border-radius:999px; cursor:pointer;
      font-size:13px; color:var(--ink); background:#0b1224; min-height:var(--tap); display:flex; align-items:center; }
    .cat-chip:active{ transform:translateY(1px) }

    .bar{ display:flex; align-items:center; gap:8px; background:#0b1224; border:1px solid var(--border);
      border-radius:var(--radius); padding:8px; min-width:0; overflow:hidden; min-height:var(--tap); }
    .ps1{ color:var(--green); user-select:none; display:inline; opacity:.9 }
    .printwrap{ display:none } @media (min-width:420px){ .printwrap{ display:inline } }
    input[type="text"]{ flex:1; min-width:0; background:transparent; border:0; outline:none; color:var(--ink); font:inherit; padding:6px 2px; line-height:1.4; font-size:16px; }
    .send{ flex:0 0 auto; appearance:none; border:0; background:#0b1224; border-left:1px solid var(--border); padding:10px 14px; border-radius:10px; cursor:pointer; color:var(--ink); font:inherit; min-height:var(--tap); }
    .send:active{ transform:translateY(1px) }
    @media (min-width:768px){ .log{ padding:16px } .bar{ padding:10px } }
    @media (max-width:360px){ .cat-chip{ padding:6px 10px; font-size:12px } .bar{ gap:6px } .send{ padding:10px 12px } }
    @media (prefers-reduced-motion: reduce){ .footer{ transition:none } .cat-chip:active{ transform:none } }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="titlebar">
      <div style="display:flex; align-items:center; gap:8px">
        <div class="dots"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div>
        <div class="title">terminal-chat</div>
      </div>
      <div class="status"><span class="on">●</span> connected</div>
    </div>

    <div id="log" class="log" aria-live="polite"></div>

    <div class="footer" id="footer">
      <div class="cats hidden" id="cats" aria-label="카테고리 바로가기"></div>
      <div class="bar">
        <span class="ps1 printwrap" id="pre">&gt;&gt; print('</span>
        <input id="inp" type="text" autocomplete="off" autocapitalize="none" spellcheck="false"
               placeholder="이름을 입력하세요" inputmode="text" enterkeyhint="send" />
        <span class="ps1 printwrap" id="post">')</span>
        <button class="send" id="sendBtn" aria-label="전송">⏎</button>
      </div>
    </div>
  </div>

  <script>
    // ===== DOM =====
    const log     = document.getElementById('log');
    const inp     = document.getElementById('inp');
    const sendBtn = document.getElementById('sendBtn');
    const footer  = document.getElementById('footer');
    const catsEl  = document.getElementById('cats');
    const preEl   = document.getElementById('pre');
    const postEl  = document.getElementById('post');

    // ===== State =====
    const state = { name:null, awaitingName:true };
    let allowCatsVisible = false;
    let CATS = [];

    // ===== Repo Config =====
    const GH = { owner:'kuanwoo10', repo:'bookcuration.github.io', branch:'main', baseDir:'카테고리' };

    // ===== Helpers =====
    function esc(s){ return String(s).replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
    function setCatsVisible(v){ catsEl.classList.toggle('hidden', !v); }
    function categoriesText(){ return CATS.length ? `{ ${CATS.map(esc).join(', ')} }` : '{ (불러오는 중) }'; }
    function pushLine({role="bot", promptText=null, html=""}){
      const row = document.createElement('div');
      row.className = role==='sys' ? 'line sys' : `line ${role}`;
      if(role==='sys'){
        row.innerHTML = html;
      }else{
        const p = document.createElement('span');
        p.className = 'prompt';
        const defaultPrompt = role==='user' ? (state.name?`${state.name}@local:~`:'guest@local:~') : 'term@host:~';
        p.textContent = promptText ?? defaultPrompt;
        const body = document.createElement('div');
        body.className = 'out';
        body.innerHTML = html;
        row.appendChild(p); row.appendChild(body);
      }
      log.appendChild(row);
      log.scrollTop = log.scrollHeight;
    }

    // ===== GitHub API =====
    function encPath(path){ return path.split('/').map(encodeURIComponent).join('/'); }
    function ghListURL(path){ const p=encPath(path); return `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${p}?ref=${GH.branch}`; }
    async function listDir(path){
      const res = await fetch(ghListURL(path), { headers:{'Accept':'application/vnd.github+json'}, cache:'no-store' });
      if(!res.ok) throw new Error(`GitHub API ${res.status}`);
      return await res.json();
    }
    async function loadCategories(){
      try{
        const items = await listDir(GH.baseDir);
        const dirs  = items.filter(x=>x.type==='dir');
        CATS = dirs.map(x=>x.name);
        pushLine({ role:'sys', html: CATS.length
          ? `레포에서 카테고리를 읽었습니다 → <b>${CATS.map(esc).join(', ')}</b>`
          : `<span class='err'>카테고리 폴더가 비어있습니다.</span>` });
        renderCategoryChips();
      }catch(err){
        pushLine({ role:'sys', html:`<span class='err'>GitHub에서 카테고리 목록을 불러오지 못했습니다:</span> ${esc(err.message)}` });
      }
    }
    function renderCategoryChips(){
      catsEl.innerHTML = '';
      CATS.forEach(cat=>{
        const b = document.createElement('button');
        b.className = 'cat-chip'; b.type = 'button'; b.textContent = cat;
        // 클릭 시 입력창에만 채워 넣기 (자동 이동 X)
        b.addEventListener('click', (e)=>{ e.preventDefault(); inp.value = cat; inp.focus(); });
        catsEl.appendChild(b);
      });
    }

    async function pickRandomQuoteFromCategory(category){
      try{
        const items = await listDir(`${GH.baseDir}/${category}`);
        const files = items.filter(x=>x.type==='file' && /\.txt$/i.test(x.name));
        if(!files.length) return `${category} 폴더에 .txt 파일이 없습니다.`;
        const choice = files[Math.floor(Math.random()*files.length)];
        const res = await fetch(choice.download_url, { cache:'no-store' });
        if(!res.ok) throw new Error(`raw ${res.status}`);
        const text = (await res.text()).trim();
        return text || '(빈 파일)';
      }catch(err){
        return `글귀를 불러오는 중 오류가 발생했습니다: ${err.message}`;
      }
    }

    // ===== Actions =====
    async function showQuoteModal(category){
      pushLine({ role:'bot', html:`<b>${esc(category)}</b> 카테고리에서 글귀를 불러옵니다…` });
      const quote = await pickRandomQuoteFromCategory(category);
      window.openQuoteModal(quote, category);
    }

    // ===== Commands =====
    function cmdHelp(){
      pushLine({ role:'bot', html:[
        "<span class='dim'>사용법</span>",
        "<br>1) 이름 입력 후 사용자 프롬프트가 바뀝니다.",
        "<br>2) 입력창은 <b>&gt;&gt; print(' ... ')</b> 형식 유지.",
        "<br>3) clear / help.",
        "<br>4) 카테고리 버튼을 누르거나 이름 입력."
      ].join("") });
    }

    async function submit(){
      const text = inp.value.trim();
      if(!text) return;
      inp.value = '';
      pushLine({ role:'user', html: esc(text) });

      // clear / help
      const low = text.toLowerCase();
      if(low==='clear'){
        log.innerHTML = '';
        pushLine({ role:'bot', html:'화면을 지웠어요.' });
        if(!state.name){
          pushLine({ role:'bot', html:'성함을 말씀해주세요.' });
          inp.placeholder = '이름을 입력하세요';
          state.awaitingName = true;
        }
        try{ inp.blur(); }catch(_){}
        return;
      }
      if(low==='help'){ cmdHelp(); try{ inp.blur(); }catch(_){} return; }

      // 이름 단계
      if(state.awaitingName){
        state.name = text; state.awaitingName = false;
        pushLine({ role:'bot', html:`반가워요, <span class="cyan">${esc(state.name)}</span>! 이런 카테고리를 추천해드릴게요.\n${categoriesText()}` });
        inp.placeholder = `카테고리를 입력하세요… ${categoriesText()}`;
        allowCatsVisible = true; requestAnimationFrame(()=> setCatsVisible(true));
        try{ inp.blur(); }catch(_){}
        return;
      }

      // 카테고리 정확 일치 시 모달
      if(CATS.includes(text)){
        await showQuoteModal(text);
        try{ inp.blur(); }catch(_){}
        return;
      }

      // 기본 에코
      pushLine({ role:'bot', html:`\"${esc(text)}\" 라고 하셨네요.` });
      try{ inp.blur(); }catch(_){}
    }

    // ===== Events =====
    inp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); submit(); }});
    sendBtn.addEventListener('click', submit);

    // ===== Keyboard Insets (모바일 키보드 대응) =====
    function currentFooterHeight(){
      return footer ? footer.getBoundingClientRect().height : 0;
    }
    function applyFooterTransform(bottomInsetPx){
      const inset = Math.max(0, bottomInsetPx|0);
      footer.style.transform = `translate3d(0,${-inset}px,0)`;
      // 입력창이 겹치지 않도록 log 아래 패딩을 footer 높이 + 인셋으로 확보
      log.style.paddingBottom = `${inset + currentFooterHeight()}px`;
    }
    function computeBottomInset(){
      if(!window.visualViewport) return 0;
      const vv = visualViewport;
      const inset = (window.innerHeight - vv.height - vv.offsetTop);
      return Math.max(0, Math.round(inset));
    }
    function updateKeyboardInsets(){ applyFooterTransform(computeBottomInset()); }
    function reserveFooterSpace(){ log.style.paddingBottom = `${currentFooterHeight()}px`; }
    function ensureInputVisible(){ try{ setTimeout(()=> inp.scrollIntoView({block:'center', behavior:'smooth'}), 0); }catch(_){} }

    if(window.visualViewport){
      visualViewport.addEventListener('resize', ()=>{ updateKeyboardInsets(); });
      visualViewport.addEventListener('scroll',  ()=>{ updateKeyboardInsets(); });
    }
    window.addEventListener('resize', ()=>{ reserveFooterSpace(); updateKeyboardInsets(); });
    window.addEventListener('orientationchange', ()=>{ reserveFooterSpace(); updateKeyboardInsets(); });

    inp.addEventListener('focus', ()=>{ ensureInputVisible(); });
    inp.addEventListener('blur',  ()=>{ updateKeyboardInsets(); });

    // ===== Boot =====
    pushLine({ role:'bot', html:'성함이 어떻게 되시나요?' });
    setCatsVisible(false); updateKeyboardInsets(); reserveFooterSpace(); loadCategories();
    const style = document.createElement('style');
    style.textContent = `.cyan{ color:${getComputedStyle(document.documentElement).getPropertyValue('--cyan')||'#06b6d4'} }`;
    document.head.appendChild(style);

    // expose for modal next button
    window.pickRandomQuoteFromCategory = pickRandomQuoteFromCategory;
  </script>

  <!-- ===== Quote Modal (Popup) ===== -->
  <style>
    #quoteModal{position:fixed; inset:0; display:none; z-index:9999; align-items:center; justify-content:center}
    #quoteModal.open{display:flex}
    #quoteModal .backdrop{position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter:blur(2px)}
    #quoteModal .sheet{position:relative; width:min(680px,92vw); max-height:86vh; background:#0b1224; border:1px solid var(--border, #1f2a44);
      border-radius:16px; padding:16px; padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px)); display:flex; flex-direction:column; gap:12px; box-shadow:0 18px 40px rgba(0,0,0,.45)}
    #quoteModal .head{display:flex; align-items:center; justify-content:space-between; gap:8px}
    #quoteModal .ttl{font-weight:800; letter-spacing:.2px}
    #quoteModal .body{overflow:auto; -webkit-overflow-scrolling:touch; padding:6px 2px; line-height:1.6}
    #quoteModal .q{font-size:clamp(16px,4.6vw,20px); white-space:pre-wrap; color: #FFFFF0; font-family: 'Nanum Gothic', 'Apple SD Gothic Neo', 'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;}
    #quoteModal .foot{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:4px}
    #quoteModal .btn{appearance:none; border:1px solid var(--border, #1f2a44); background:#0f172a; color:var(--ink, #e5e7eb);
      border-radius:12px; padding:12px 14px; min-height:48px; cursor:pointer; font:inherit}
    #quoteModal .btn.primary{background:#0b1224; border-color:#1f2a44}
    #quoteModal .btn.danger{background:#141824; border-color:#2a324a}
  </style>

  <div id="quoteModal" role="dialog" aria-modal="true" aria-labelledby="qm-title" aria-describedby="qm-body">
    <div class="backdrop" data-close="1"></div>
    <div class="sheet">
      <div class="head">
        <div class="ttl" id="qm-title">추천 글귀</div>
        <button class="btn danger" id="qm-close" aria-label="닫기">X</button>
      </div>
      <div class="body" id="qm-body">
        <div class="q" id="qm-quote">로딩 중…</div>
      </div>
      <div class="foot">
        <button class="btn" id="qm-copy">복사</button>
        <button class="btn primary" id="qm-next">다른 글귀</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Quote Modal Helpers =====
    (function(){
      if (window.__quote_modal_init__) return; // prevent double init
      window.__quote_modal_init__ = true;

      const qm = window.qm = {
        root:  document.getElementById('quoteModal'),
        title: document.getElementById('qm-title'),
        quote: document.getElementById('qm-quote'),
        btnClose: document.getElementById('qm-close'),
        btnCopy:  document.getElementById('qm-copy'),
        btnNext:  document.getElementById('qm-next'),
        currentCategory: null,
      };

      window.openQuoteModal = function(text, category){
        qm.currentCategory = category || null;
        if (qm.title) qm.title.textContent = category ? (category + ' · 추천 글귀') : '추천 글귀';
        if (qm.quote) qm.quote.textContent = text || '';
        if (qm.root) qm.root.classList.add('open');
        try{ document.body.style.overflow = 'hidden'; }catch(_){ }
        try{ qm.btnClose && qm.btnClose.focus(); }catch(_){ }
        // 모달 오픈 시 키보드가 떠있다면 닫기
        try{ inp.blur(); }catch(_){ }
      };
      window.closeQuoteModal = function(){
        if (qm.root) qm.root.classList.remove('open');
        try{ document.body.style.overflow = ''; }catch(_){ }
      };

      qm && qm.btnClose && qm.btnClose.addEventListener('click', window.closeQuoteModal);
      qm && qm.root && qm.root.addEventListener('click', (e)=>{ if(e.target && e.target.dataset && e.target.dataset.close) window.closeQuoteModal(); });
      qm && qm.btnCopy && qm.btnCopy.addEventListener('click', async ()=>{
        try{
          await navigator.clipboard.writeText(qm.quote?.textContent || '');
          const t = qm.btnCopy.textContent; qm.btnCopy.textContent = '복사됨!';
          setTimeout(()=> qm.btnCopy.textContent = t, 900);
        }catch(_){ }
      });
      qm && qm.btnNext && qm.btnNext.addEventListener('click', async ()=>{
        try{
          if(!qm.currentCategory) return;
          qm.btnNext.disabled = true;
          const q = await (window.pickRandomQuoteFromCategory?.(qm.currentCategory));
          if(qm.quote) qm.quote.textContent = q || '';
        }finally{
          qm.btnNext.disabled = false;
        }
      });

      // Esc로 닫기
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape' && qm.root && qm.root.classList.contains('open')){
          window.closeQuoteModal();
        }
      });
    })();
  </script>
</body>
</html>
