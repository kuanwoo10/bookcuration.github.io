<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>터미널 챗</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#0f172a; --ink:#e5e7eb; --dim:#94a3b8; --green:#22c55e; --cyan:#06b6d4; --danger:#ef4444; --border:#1f2937;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    *{ box-sizing:border-box }
    html,body{ height:100%; margin:0; background:linear-gradient(180deg,#0a0f1e,#0d1530) }
    body{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      color:var(--ink); display:flex; align-items:center; justify-content:center;
      -webkit-tap-highlight-color: transparent; touch-action: manipulation;
    }

    /* 앱을 '안 흔들리는' 높이로 고정 */
    .app{
      position: relative; /* 절대 배치 기준 */
      width:min(920px, 100%);
      height:100lvh; /* 키보드 등장에도 변하지 않는 큰 뷰포트 */
      max-height: 820px;
      background:var(--panel);
      border:1px solid var(--border); border-radius:14px;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      display:flex; flex-direction:column; overflow:hidden;
    }
    @supports not (height: 100lvh){
      .app{ height:100vh; } /* 레거시 폴백 */
    }

    .titlebar{ display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#111827,#0f172a); }
    .dots{ display:flex; gap:8px }
    .dot{ width:10px; height:10px; border-radius:50% }
    .dot.red{ background:#ef4444 } .dot.yellow{ background:#f59e0b } .dot.green{ background:#22c55e }
    .title{ font-weight:800; letter-spacing:.4px }
    .status{ font-size:12px; color:var(--dim) } .status .on{ color:var(--green) }

    .cats{ display:flex; gap:8px; padding:8px 12px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#0e1430,#0f172a); overflow-x:auto; scrollbar-width:thin; }
    .cats::-webkit-scrollbar{ height:6px }
    .cats::-webkit-scrollbar-thumb{ background:#1f2a44; border-radius:999px }
    .cat-chip{ flex:0 0 auto; padding:6px 10px; border:1px solid var(--border); border-radius:999px; cursor:pointer; font-size:12px; color:var(--ink); background:#0b1224; }
    .cat-chip:active{ transform:translateY(1px) }
    .hidden{ display:none !important }

    .log{
      position: relative;
      flex:1; overflow-y:auto; padding:16px;
      background:repeating-linear-gradient(0deg, #0f172a, #0f172a 22px, #0e162d 22px, #0e162d 44px);
      scroll-behavior:smooth; overscroll-behavior:contain;
      padding-bottom:0; /* 입력바가 가려도 OK (요청사항) */
    }
    .line{ display:flex; gap:10px; margin:6px 0; white-space:pre-wrap; word-break:break-word }
    .prompt{ color:var(--green) }
    .user .prompt::after{ content:"$" }
    .bot  .prompt::after{ content:"#" }
    .sys{ justify-content:center; color:var(--dim); font-size:12px }
    .out{ color:var(--ink) }
    .dim{ color:var(--dim) }
    .err{ color:var(--danger) }

    /* 입력 바: 레이아웃에서 분리 → 이것만 움직임 */
    .footer{
      position:absolute; left:0; right:0; bottom:0; z-index:10;
      transition: transform .18s ease;
      padding:12px;
      padding-bottom: calc(12px + var(--safe-bottom));
      background:linear-gradient(180deg, rgba(13,21,48,0), #0f172a 60%);
      transform: translate3d(0,0,0); will-change: transform; /* GPU 가속 */
    }
    .bar{
      display:flex; align-items:center; gap:8px; background:#0b1224;
      border:1px solid var(--border); border-radius:12px; padding:10px;
      min-width:0; overflow:hidden;
    }
    .ps1{ color:var(--green); user-select:none; display:inline }
    /* 작은 화면에서는 print 프롬프트 텍스트 감춤 → 입력칸/버튼 확보 */
    .printwrap{ display:none; }
    @media (min-width: 420px){
      .printwrap{ display:inline; }
    }
    input[type="text"]{
      flex:1; min-width:0;
      background:transparent; border:0; outline:none; color:var(--ink); font:inherit;
      padding:6px 2px; line-height:1.4; font-size:16px;
    }
    .send{
      flex:0 0 auto; appearance:none; border:0; background:#0b1224;
      border-left:1px solid var(--border); padding:10px 12px; border-radius:10px;
      cursor:pointer; color:var(--ink); font:inherit;
    }
    .send:active{ transform:translateY(1px) }

    @media (max-width: 640px){
      .app{ width:100%; max-height:none; border-radius:0; border-left:0; border-right:0; }
      .titlebar{ padding:8px 12px }
      .log{ padding:12px }
      .bar{ padding:8px }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="titlebar">
      <div style="display:flex; align-items:center; gap:10px">
        <div class="dots"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div>
        <div class="title">terminal-chat</div>
      </div>
      <div class="status"><span class="on">●</span> connected</div>
    </div>

    <div class="cats hidden" id="cats" aria-label="카테고리 바로가기"></div>
    <div id="log" class="log" aria-live="polite"></div>

    <div class="footer" id="footer">
      <div class="bar">
        <span class="ps1 printwrap" id="pre">&gt;&gt; print('</span>
        <input id="inp" type="text" autocomplete="off" placeholder="이름을 입력하세요" inputmode="text" />
        <span class="ps1 printwrap" id="post">')</span>
        <button class="send" id="sendBtn" aria-label="전송">실행</button>
      </div>
    </div>
  </div>

  <script>
    // ===== DOM =====
    const log     = document.getElementById('log');
    const inp     = document.getElementById('inp');
    const sendBtn = document.getElementById('sendBtn');
    const footer  = document.getElementById('footer');
    const catsEl  = document.getElementById('cats');
    const preEl   = document.getElementById('pre');
    const postEl  = document.getElementById('post');

    // ===== State =====
    const state   = { name:null, awaitingName:true };
    const uiState = { mode:'chat', snapshot:null, reco:null };
    let   allowCatsVisible = false;
    let   CATS = [];

    // ===== Repo Config =====
    const GH = { owner:'kuanwoo10', repo:'bookcuration.github.io', branch:'main', baseDir:'카테고리' };

    // ===== Helpers =====
    function esc(s){ return String(s).replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
    function setCatsVisible(v){ catsEl.classList.toggle('hidden', !v); }
    function categoriesText(){ return CATS.length ? `{ ${CATS.map(esc).join(', ')} }` : '{ (불러오는 중) }'; }

    function pushLine({role="bot", promptText=null, html=""}){
      const row = document.createElement('div');
      row.className = role==='sys' ? 'line sys' : `line ${role}`;
      if(role==='sys'){
        row.innerHTML = html;
      }else{
        const p = document.createElement('span');
        p.className = 'prompt';
        const defaultPrompt = role==='user' ? (state.name?`${state.name}@local:~`:'guest@local:~') : 'term@host:~';
        p.textContent = promptText ?? defaultPrompt;
        const body = document.createElement('div');
        body.className = 'out';
        body.innerHTML = html;
        row.appendChild(p); row.appendChild(body);
      }
      log.appendChild(row);
      log.scrollTop = log.scrollHeight;
    }

    // ===== GitHub API =====
    function encPath(path){ return path.split('/').map(encodeURIComponent).join('/'); }
    function ghListURL(path){ const p=encPath(path); return `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${p}?ref=${GH.branch}`; }
    async function listDir(path){
      const res = await fetch(ghListURL(path), { headers:{'Accept':'application/vnd.github+json'}, cache:'no-store' });
      if(!res.ok) throw new Error(`GitHub API ${res.status}`);
      return await res.json();
    }

    async function loadCategories(){
      try{
        const items = await listDir(GH.baseDir);
        const dirs  = items.filter(x=>x.type==='dir');
        CATS = dirs.map(x=>x.name);
        renderCategoryChips();
      }catch(err){
        pushLine({ role:'sys', html:`<span class='err'>GitHub에서 카테고리 목록을 불러오지 못했습니다:</span> ${esc(err.message)}` });
      }
    }

    function renderCategoryChips(){
      catsEl.innerHTML = '';
      CATS.forEach(cat=>{
        const b = document.createElement('button');
        b.className = 'cat-chip';
        b.type = 'button';
        b.textContent = cat;
        // 클릭 시 바로 이동하지 않고 입력창에만 채워줌
        b.addEventListener('click', (e)=>{
          e.preventDefault();
          inp.value = cat;
          inp.focus();
        });
        catsEl.appendChild(b);
      });
    }

    async function pickRandomQuoteFromCategory(category){
      try{
        const items = await listDir(`${GH.baseDir}/${category}`);
        const files = items.filter(x=>x.type==='file' && /\.txt$/i.test(x.name));
        if(!files.length) return `${category} 폴더에 .txt 파일이 없습니다.`;
        const choice = files[Math.floor(Math.random()*files.length)];
        const res = await fetch(choice.download_url, { cache:'no-store' });
        if(!res.ok) throw new Error(`raw ${res.status}`);
        const text = (await res.text()).trim();
        return text || '(빈 파일)';
      }catch(err){
        return `글귀를 불러오는 중 오류가 발생했습니다: ${err.message}`;
      }
    }

    // ===== Modes =====
    async function enterRecommendationMode(category){
      // 스냅샷 저장
      uiState.snapshot = { logHTML: log.innerHTML, placeholder: inp.placeholder, input: inp.value };
      uiState.mode = 'reco';

      // 카테고리 바 숨김
      setCatsVisible(false);

      // 화면 클리어 & 안내
      log.innerHTML = '';
      pushLine({ role:'bot', html:`<b>${esc(category)}</b> 카테고리에서 이런 글귀를 추천해요.` });

      // 글귀 로드
      const quote = await pickRandomQuoteFromCategory(category);
      pushLine({ role:'bot', html:`“${esc(quote)}”` });

      // 입력 비활성화 + Back 전용
      inp.value = '';
      inp.placeholder = '이전 화면으로 돌아가려면 Back 버튼을 누르세요.';
      inp.disabled = true;
      if(preEl)  preEl.style.opacity = '0.35';
      if(postEl) postEl.style.opacity = '0.35';
      sendBtn.textContent = 'Back';
      sendBtn.setAttribute('data-action','back');

      uiState.reco = { category };
    }

    function restoreFromRecommendation(){
      if(!uiState.snapshot) return;

      log.innerHTML    = uiState.snapshot.logHTML;
      inp.placeholder  = uiState.snapshot.placeholder;
      inp.value        = uiState.snapshot.input || '';
      uiState.mode     = 'chat';
      uiState.snapshot = null;
      uiState.reco     = null;

      // 입력 재활성화
      inp.disabled = false;
      if(preEl)  preEl.style.opacity = '1';
      if(postEl) postEl.style.opacity = '1';
      sendBtn.textContent = '실행';
      sendBtn.removeAttribute('data-action');
      pushLine({ role:'bot', html:'이전 대화로 돌아왔어요.' });

      if(allowCatsVisible) setCatsVisible(true);
    }

    // ===== Commands =====

    async function submit(){
      // reco 모드에서 Back만 허용
      if(uiState.mode==='reco' && sendBtn.dataset.action==='back'){
        restoreFromRecommendation();
        return;
      }

      const text = inp.value.trim();
      if(!text) return;

      inp.value = '';
      pushLine({ role:'user', html: esc(text) });

      // reco 모드에서 임의 입력 → 안내만
      if(uiState.mode==='reco'){
        pushLine({ role:'sys', html:'지금 화면에서는 <b>Back</b>만 사용할 수 있어요.' });
        return;
      }

      // clear / help
      const low = text.toLowerCase();
      if(low==='clear'){
        log.innerHTML = '';
        pushLine({ role:'bot', html:'화면을 지웠어요.' });
        if(!state.name){
          pushLine({ role:'bot', html:'성함을 말씀해주세요.' });
          inp.placeholder = '이름을 입력하세요';
          state.awaitingName = true;
        }
        return;
      }
      if(low==='help'){ cmdHelp(); return; }

      // 이름 단계
      if(state.awaitingName){
        state.name = text;
        state.awaitingName = false;
        pushLine({ role:'bot', html:`반가워요, <span class="cyan">${esc(state.name)}</span>! 이런 카테고리를 추천해드릴게요.\n${categoriesText()}` });
        inp.placeholder = `카테고리를 입력하세요… ${categoriesText()}`;
        // 메시지가 먼저 보이고 다음 프레임에 카테고리바 표시
        allowCatsVisible = true;
        requestAnimationFrame(()=> setCatsVisible(true));
        return;
      }

      // 카테고리 정확 일치 시 추천 모드
      if(CATS.includes(text)){
        await enterRecommendationMode(text);
        return;
      }

      // 기본 에코
      pushLine({ role:'bot', html:`\"${esc(text)}\" 라고 하셨네요.` });
    }

    // ===== Events =====
    inp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); submit(); }});
    sendBtn.addEventListener('click', ()=>{
      if(uiState.mode==='reco' && sendBtn.dataset.action==='back'){ restoreFromRecommendation(); }
      else { submit(); }
    });

    // ===== Keyboard Insets (모바일) - 입력 바만 올리기 =====
    function updateKeyboardInsets(){
      if(!window.visualViewport) return;
      const vv = visualViewport;
      const bottomInset = Math.max(0,(window.innerHeight - vv.height - vv.offsetTop));
      footer.style.transform = `translate3d(0,${-bottomInset}px,0)`; // 입력 바만 위로
    }
    function reserveFooterSpace(){
      // 로그는 가려져도 OK → 하단 여백 없이 유지
      log.style.paddingBottom = '0px';
    }
    if(window.visualViewport){
      visualViewport.addEventListener('resize', ()=>{ updateKeyboardInsets(); reserveFooterSpace(); });
      visualViewport.addEventListener('scroll', updateKeyboardInsets);
    }
    window.addEventListener('resize', reserveFooterSpace);

    // ===== Boot =====
    pushLine({ role:'bot', html:'성함이 어떻게 되시나요?' });
    setCatsVisible(false);
    updateKeyboardInsets();
    reserveFooterSpace();
    loadCategories();

    // 테마 색 적용용 유틸 클래스
    const style = document.createElement('style');
    style.textContent = `.cyan{ color:${getComputedStyle(document.documentElement).getPropertyValue('--cyan')||'#06b6d4'} }`;
    document.head.appendChild(style);
  </script>
</body>
</html>
