<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>터미널 챗</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#0f172a; --ink:#e5e7eb; --dim:#94a3b8; --green:#22c55e; --cyan:#06b6d4; --danger:#ef4444; --border:#1f2937;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --vh: 1dvh;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#0a0f1e,#0d1530)}
    body{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      color:var(--ink); display:flex; align-items:center; justify-content:center;
      -webkit-tap-highlight-color: transparent; touch-action: manipulation;
    }

    .app{ width:min(920px, 100%); height:100svh; max-height: 820px;
      background:var(--panel); border:1px solid var(--border); border-radius:14px;
      box-shadow:0 18px 40px rgba(0,0,0,.35); display:flex; flex-direction:column; overflow:hidden; }

    .titlebar{ display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#111827,#0f172a); }
    .dots{display:flex; gap:8px}.dot{width:10px;height:10px;border-radius:50%}.dot.red{background:#ef4444}.dot.yellow{background:#f59e0b}.dot.green{background:#22c55e}
    .title{font-weight:800; letter-spacing:.4px}
    .status{font-size:12px; color:var(--dim)}.status .on{color:var(--green)}

    .cats{ display:flex; gap:8px; padding:8px 12px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#0e1430,#0f172a); overflow-x:auto; scrollbar-width:thin; }
    .cats::-webkit-scrollbar{ height:6px }
    .cats::-webkit-scrollbar-thumb{ background:#1f2a44; border-radius:999px }
    .cat-chip{ flex:0 0 auto; padding:6px 10px; border:1px solid var(--border); border-radius:999px; cursor:pointer; font-size:12px; color:var(--ink); background:#0b1224; }
    .cat-chip:active{ transform:translateY(1px) }

    .log{ flex:1; overflow-y:auto; padding:16px; background:repeating-linear-gradient(0deg, #0f172a, #0f172a 22px, #0e162d 22px, #0e162d 44px); scroll-behavior:smooth; overscroll-behavior:contain; }
    .line{display:flex; gap:10px; margin:6px 0; white-space:pre-wrap; word-break:break-word}
    .prompt{color:var(--green)} .user .prompt::after{content:"$";} .bot .prompt::after{content:"#";}
    .sys{justify-content:center; color:var(--dim); font-size:12px} .out{color:var(--ink)}

    .footer{ $1 transition: transform .18s ease; }
    .bar{display:flex; align-items:center; gap:8px; background:#0b1224; border:1px solid var(--border); border-radius:12px; padding:10px; }
    .ps1{color:var(--green); user-select:none; display:inline}
    input[type="text"]{ flex:1; background:transparent; border:0; outline:none; color:var(--ink); font:inherit; padding:6px 2px; line-height:1.4; font-size:16px; }
    .send{ appearance:none; border:0; background:#0b1224; border-left:1px solid var(--border); padding:10px 12px; border-radius:10px; cursor:pointer; color:var(--ink); font:inherit; }
    .send:active{ transform:translateY(1px) }

    @media (max-width: 640px){
      .app{ width:100%; max-height:none; border-radius:0; border-left:0; border-right:0; height:100svh; }
      .titlebar{ padding:8px 12px }
      .log{ padding:12px }
      .bar{ padding:8px }
    }
    @supports not (height: 100svh){
      .app{ height:100vh; }
    }
      .titlebar{ padding:8px 12px }
      .log{ padding:12px }
      .bar{ padding:8px }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="titlebar">
      <div style="display:flex; align-items:center; gap:10px">
        <div class="dots"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div>
        <div class="title">terminal-chat</div>
      </div>
      <div class="status"><span class="on">●</span> connected</div>
    </div>

    <div class="cats" id="cats" aria-label="카테고리 바로가기"></div>
    <div id="log" class="log" aria-live="polite"></div>

    <div class="footer" id="footer">
      <div class="bar">
        <span class="ps1 printwrap" id="pre">&gt;&gt; print('</span>
        <input id="inp" type="text" autocomplete="off" placeholder="이름을 입력하세요" inputmode="text" />
        <span class="ps1 printwrap" id="post">')</span>
        <button class="send" id="sendBtn" aria-label="전송">⏎</button>
      </div>
    </div>
  </div>

  <script>
    const log = document.getElementById('log');
    const inp = document.getElementById('inp');
    const sendBtn = document.getElementById('sendBtn');
    const footer = document.getElementById('footer');
    const catsWrap = document.getElementById('cats');
    const state = { name:null, awaitingName:true };

    const GH = { owner:'kuanwoo10', repo:'bookcuration.github.io', branch:'main', baseDir:'카테고리' };
    let CATS = [];

    function encPath(path){ return path.split('/').map(encodeURIComponent).join('/'); }
    function ghListURL(path){ const p=encPath(path); return `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${p}?ref=${GH.branch}`; }
    async function listDir(path){ const res=await fetch(ghListURL(path),{headers:{'Accept':'application/vnd.github+json'},cache:'no-store'}); if(!res.ok) throw new Error(`GitHub API ${res.status}`); return await res.json(); }

    async function loadCategories(){
      try{
        const items=await listDir(GH.baseDir);
        const dirs=items.filter(x=>x.type==='dir');
        CATS=dirs.map(x=>x.name);
        pushLine({ role:'sys', html:CATS.length?`레포에서 카테고리를 읽었습니다 → <b>${CATS.map(esc).join(', ')}</b>`:`<span class='err'>카테고리 폴더가 비어있습니다.</span>` });
        renderCategoryChips();
      }catch(err){ pushLine({role:'sys', html:`<span class='err'>GitHub에서 카테고리 목록을 불러오지 못했습니다:</span> ${esc(err.message)}`}); }
    }

    function renderCategoryChips(){
      catsWrap.innerHTML='';
      CATS.forEach(cat=>{
        const b=document.createElement('button');
        b.className='cat-chip'; b.type='button'; b.textContent=cat;
        b.addEventListener('click',()=>enterRecommendationMode(cat));
        catsWrap.appendChild(b);
      });
    }

    async function pickRandomQuoteFromCategory(category){
      try{
        const items=await listDir(`${GH.baseDir}/${category}`);
        const files=items.filter(x=>x.type==='file'&&/\.txt$/i.test(x.name));
        if(!files.length) return `${category} 폴더에 .txt 파일이 없습니다.`;
        const choice=files[Math.floor(Math.random()*files.length)];
        const res=await fetch(choice.download_url,{cache:'no-store'});
        if(!res.ok) throw new Error(`raw ${res.status}`);
        const text=(await res.text()).trim();
        return text||'(빈 파일)';
      }catch(err){ return `글귀를 불러오는 중 오류가 발생했습니다: ${err.message}`; }
    }

    const uiState={mode:'chat',snapshot:null,reco:null};
    function categoriesText(){return CATS.length?`{ ${CATS.map(c=>esc(c)).join(', ')} }`:'{ (불러오는 중) }';}

    function enterRecommendationMode(category){
      uiState.snapshot={logHTML:log.innerHTML,placeholder:inp.placeholder,input:inp.value}; uiState.mode='reco';
      log.innerHTML=''; pushLine({role:'bot', html:`<b>${esc(category)}</b> 카테고리에서 이런 글귀를 추천해요.`});
      (async()=>{const quote=await pickRandomQuoteFromCategory(category); pushLine({role:'bot', html:`“${esc(quote)}”`});})();
      inp.value=''; inp.placeholder='이전 화면으로 돌아가려면 back 입력...';
      uiState.reco={category};
    }

    function restoreFromRecommendation(){ if(!uiState.snapshot) return; log.innerHTML=uiState.snapshot.logHTML; inp.placeholder=uiState.snapshot.placeholder; inp.value=uiState.snapshot.input||''; uiState.mode='chat'; uiState.snapshot=null; uiState.reco=null; pushLine({role:'bot',html:'이전 대화로 돌아왔어요.'}); }

    function pushLine({role="bot",promptText=null,html=""}){
      const row=document.createElement('div'); row.className=role==='sys'?'line sys':`line ${role}`;
      if(role==='sys'){row.innerHTML=html;} else {
        const p=document.createElement('span'); p.className='prompt'; const defaultPrompt=role==='user'?(state.name?`${state.name}@local:~`:'guest@local:~'):'term@host:~'; p.textContent=promptText??defaultPrompt;
        const body=document.createElement('div'); body.className='out'; body.innerHTML=html; row.appendChild(p); row.appendChild(body);
      }
      log.appendChild(row); log.scrollTop=log.scrollHeight;
    }
    function esc(s){return String(s).replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));}

    function cmdHelp(){ pushLine({role:'bot', html:["<span class='dim'>사용법</span>","<br>1) 이름 입력 후 사용자 프롬프트가 바뀝니다.","<br>2) 입력창은 >> print(' ... ') 형식 유지.","<br>3) clear / help.","<br>4) 카테고리 버튼을 누르거나 이름 입력."] .join("")}); }

    pushLine({role:'bot', html:'성함이 어떻게 되시나요?'});
    loadCategories();

    function submit(){
      const text=inp.value.trim(); if(!text) return; inp.value='';
      if(uiState.mode==='reco'){ if(text.toLowerCase()==='back'){restoreFromRecommendation();} else{pushLine({role:'sys',html:'지금 화면에서는 <b>back</b>만 사용할 수 있어요.'});} return; }
      pushLine({role:'user', html:esc(text)});
      if(text.toLowerCase()==='clear'){log.innerHTML=''; pushLine({role:'bot', html:'화면을 지웠어요.'}); if(!state.name){pushLine({role:'bot', html:'성함을 말씀해주세요.'}); inp.placeholder='이름을 입력하세요'; state.awaitingName=true;} return;}
      if(text.toLowerCase()==='help'){cmdHelp(); return;}
      if(state.awaitingName){state.name=text; state.awaitingName=false; inp.placeholder=`카테고리를 입력하세요… ${categoriesText()}`; pushLine({role:'bot', html:`반가워요, <span class=\"cyan\">${esc(state.name)}</span>! 위의 버튼을 누르거나 카테고리를 입력해 보세요. ${categoriesText()}`}); return;}
      if(CATS.includes(text)){enterRecommendationMode(text); return;}
      pushLine({role:'bot', html:`\"${esc(text)}\" 라고 하셨네요.`});
    }

    inp.addEventListener('keydown', e=>{if(e.key==='Enter'){e.preventDefault(); submit();}});
    sendBtn.addEventListener('click', submit);

    // footer 위치 조정 (키보드 올라올 때 입력창만 이동) + 로그 하단 여백 보장
    function updateKeyboardInsets(){
      if(!window.visualViewport) return;
      const vv=visualViewport;
      const bottomInset=Math.max(0,(window.innerHeight - vv.height - vv.offsetTop));
      footer.style.transform=`translateY(${-bottomInset}px)`;
    }
    function reserveFooterSpace(){
      const h = footer.offsetHeight || 64;
      log.style.paddingBottom = (h + 8) + 'px';
    }
    if(window.visualViewport){
      visualViewport.addEventListener('resize', ()=>{ updateKeyboardInsets(); reserveFooterSpace(); });
      visualViewport.addEventListener('scroll', updateKeyboardInsets);
    }
    window.addEventListener('resize', reserveFooterSpace);
    // 초기 호출
    updateKeyboardInsets();
    reserveFooterSpace();

    const style=document.createElement('style'); style.textContent=`.cyan{ color:${getComputedStyle(document.documentElement).getPropertyValue('--cyan')||'#06b6d4'} }`; document.head.appendChild(style);
  </script>
</body>
</html>
