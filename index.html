<!-- === Terminal Chat === -->
<div id="terminal-chat" class="term">
  <div id="term-out" class="out" aria-live="polite"></div>
  <form id="term-form" class="form" autocomplete="off">
    <span id="ps1" class="ps1">guest@local:~$</span>
    <input id="term-input" class="in" type="text" placeholder="여기에 입력" />
  </form>
</div>

<style>
.term{background:#0b1221;border:1px solid #1b2540;border-radius:12px;color:#e5edff;font-family:ui-monospace,Consolas,monospace}
.term .out{padding:14px 14px 6px; max-height:50vh; overflow:auto; line-height:1.7}
.term .form{display:flex; gap:8px; align-items:center; padding:10px 14px; border-top:1px solid #1b2540}
.term .ps1{color:#83a1ff}
.term .in{flex:1; background:#0e1730; color:#e5edff; border:1px solid #24335e; border-radius:8px; padding:8px 10px}
.term .sys{color:#9fb4ff}
.term .usr{color:#c9f6dd}
.term .hl {color:#ffdf6b}
.term a.link{color:#7aa7ff; text-decoration:underline}
</style>

<script>
(() => {
  // 새 창으로 열 시 전시 페이지 (경로 체크!)
  const VIEW_URL = '../today_poem/view.html';  // 예: with_code.html 기준

  // --- elements ---
  const out = document.getElementById('term-out');
  const form = document.getElementById('term-form');
  const input = document.getElementById('term-input');
  const ps1 = document.getElementById('ps1');

  // --- small helpers ---
  const scrollEnd = () => { out.scrollTop = out.scrollHeight; };
  function pushLine(prefix, text, cls='sys'){
    const div = document.createElement('div');
    div.innerHTML = `<span class="${cls==='usr'?'usr':'sys'}">${prefix}</span> ${text}`;
    out.appendChild(div); scrollEnd();
  }
  function bot(text){ pushLine('term@host:~#', text, 'sys'); }
  function me(text){ pushLine(userPrompt(), text, 'usr'); }

  // --- state machine ---
  let state = 'askName';
  let name = '';
  const cats = [1,2,3,4,5,6,7];

  function userPrompt(){
    return `${name || 'guest'}@local:~$`;
  }
  function setPrompt(){
    ps1.textContent = userPrompt();
  }

  function start(){
    bot('너 이름이 뭐야?  (그냥 이름만 입력하면 돼요)');
    setPrompt();
    input.focus();
  }

  function showCats(){
    const listStr = `[${cats.join(', ')}]`;
    bot(`반가워요, <span class="hl">${name}</span>! ${name}님에게 맞는 글귀를 추천해 줄게요.<br>마음에 드는 카테고리가 있을까요?<br><span class="hl">${listStr}</span> 중 하나를 숫자로 입력해 주세요.`);
  }

  function handleName(val){
    name = val.trim();
    if(!name){ bot('이름을 입력해 주세요.'); return; }
    me(name);
    setPrompt();
    state = 'askCat';
    showCats();
  }

  function openViewer(cat){
    const url = `${VIEW_URL}?c=${encodeURIComponent(cat)}&auto=random&n=${encodeURIComponent(name)}`;
    // 새 창 시도
    const w = window.open(url, '_blank', 'noopener');
    if(!w){
      bot(`팝업이 차단된 것 같아요. 아래 링크를 눌러 열어주세요.<br><a class="link" target="_blank" rel="noopener" href="${url}">새 창으로 열기</a>`);
    }
  }

  function handleCat(val){
    const v = val.trim();
    if(!/^[1-7]$/.test(v)){
      me(v);
      bot('1부터 7 사이의 숫자만 입력해 주세요. 예) 1');
      return;
    }
    me(v);
    bot(`<span class="hl">${v}</span>을(를) 선택하셨네요. <span class="hl">${v}</span>에 맞는 글귀를 추천해드릴게요!`);
    openViewer(v);
    // 다음 선택을 이어갈 수 있게 상태 유지
    showCats();
  }

  // submit
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const val = input.value;
    input.value = '';
    if(state === 'askName') handleName(val);
    else handleCat(val);
  });

  // 시작
  start();
})();
</script>
